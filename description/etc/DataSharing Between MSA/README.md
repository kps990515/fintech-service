## MSA간의 데이터 공유

### 마이크로서비스와 데이터 관리의 핵심 원칙
1. 느슨한 결합: 서비스 간의 독립성을 유지하여, 하나의 서비스에서 변경이 발생해도 다른 서비스에 영향을 주지 않도록 합니다.
2. 서비스 자율성: 서비스가 각기 독립적으로 발전하고 배포될 수 있게 하여, 다른 팀과의 조정이 필요하지 않도록 합니다.

### 데이터 소스 공유와 데이터 공유의 차이
- DB공유는 지양하지만 데이터 공유는 필요 
- 방법
    1. 데이터 복제 (이벤트 기반 통신)
       - 장점 : 느슨한 결합 / 결함 전파 안됨 / 확장성
       - 단점 : 데이터 일관성 부족 / 복잡성
    2. API 기반 데이터 공유 (동기 통신)
        - 장점 : 최신 데이터 공유, 단순함
        - 단점 : 강한 결합(장애 전파), 확장성 어려움
    3. 데이터베이스 뷰 공유 (읽기 전용 접근)
        - 장점 : 데이터 무결성, 단순함
        - 단점 : 다른 서비스의 DB에 결합도 발생, 유연성제한(DB 스키마 변경 어려움)
    4. 공유 캐시 (Redis 등)
        - 장점 : 성능향상, DB 부하 감소
        - 단점 : 데이터 일관성 부족, 관리 복잡성
    5. 공유 파일 저장소 (AWS S3)
        - 장점 : 단순성, 확장성
        - 단점 : 데이터 일관성, DB보다 느릴수 있음

### MSA간 데이터 공유 종류
![img](https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F111e893a-29b4-45c8-b8fd-d5bee6f21a86_1444x1600.png)
1. 동기식 데이터 공유
   - 특징: 실시간으로 서비스간 데이터 공유
   - 장점: 데이터가 항상 최신 상태로 유지, 즉각적인 응답 수신
   - 단점: 서비스 간 강한 의존성이 생기며, 한 서비스의 장애가 다른 서비스에 영향을 미칠 수 있습니다.
2. 비동기식 데이터 공유
    - 특징 : 이벤트를 통해 데이터를 공유하며, 데이터 일관성은 결국 보장 (최종 일관성)
    - 예시 : Product Service에서 제품 업데이트 이벤트를 발생시키고, 이를 Order Service가 처리하는 구조
    - 장점 : 서비스 간 의존성을 줄이고, 더 나은 확장성을 제공
    - 단점 : 데이터 일관성이 즉시 보장되지 않으며, 잠시 동안의 불일치가 발생가능
3. 하이브리드 접근 방식 
    - 특징 : 동기식과 비동기식 접근 방식을 혼합하여 사용
    - 예시 : Driver Service가 데이터를 비동기로 수신, 특정 시점에는 동기식 호출을 사용해 Ride Service와 상호작용
    - 장점 : 유연한 데이터 공유가 가능하며, 상황에 맞는 최적의 방법을 선택가능
    - 단점 : 복잡성이 증가하며, 관리가 어려움
4. 트레이드오프 및 결정 요소
    - 일관성 요구 사항 평가: 강한 일관성을 유지할 것인지, 최종 일관성을 허용할 것인지 결정
    - 성능 고려 사항: 지연 시간, 처리량, 리소스 활용과 같은 성능 측면을 고려
    - 확장성 고려 사항: 수평 확장성, 데이터 양, 서비스 발전 가능성

### 데이터 소스 공유와 데이터 공유의 차이
- 데이터 소스 공유
  - 여러 서비스가 동일한 데이터베이스에 직접 접근하는 것을 의미
  - 서비스 간의 강한 결합이 발생할 수 있고, 서비스의 독립성이 훼손
  - 마이크로서비스에서 권장되지 않음
- 데이터 공유
  - 데이터 소스가 아닌 데이터를 서비스 간에 교환하는 방식
  - API나 메시징 패턴을 통해 데이터를 주고받으며, 필요한 데이터는 각 서비스의 로컬 사본으로 유지
  - 서비스 독립성과 느슨한 결합을 유지

### 동기식 데이터 공유의 종류
- 장점 : 강한 데이터 일관성 보장
- 단점 : 확장성, 성능, 장애 전파
1. API 요청/응답 모델 (Request/Response Model)
    - 문제점
      - 응답시간 증가 :  호출이 많아질수록 시스템의 응답 시간 증가
      - 연쇄적 실패 : 하나의 서비스에 문제가 생기면 다른서비스에도 문제 전파
      - 자원 활용 : 서비스가 응답을 기다리는 동안 연결을 유지해야 하므로, 많은 자원이 소비
      - 네트워크 혼잡 : 비스 간 호출이 많아질수록 네트워크 트래픽이 증가하며, 네트워크가 병목현상 발생
    - 대안 : 데이터를 복제하여 공유
      - 문제점 : 데이터 일관성 부족함
2. 게이트웨이 접근 방식
    - 작동방식(예시)
      1. 코디네이터 역할 : 게이트웨이 역할로서 업데이트 프로세스 시작
      2. 업데이트 요청 : 관련 서비스들에 업데이트 요청 전달
      3. 성공 및 실패 확인 : 서비스들의 응답 확인, 모든 서비스가 성공하면 트랜잭션 완료로 간주, 하나라도 실패하면 롤백
    - 장점
      - 구현이 간단함
      - 데이터 일관성 보장
    - 단점
      - 장애 전파 가능성 높음
      - 부분 실패 처리 어려움

### 비동기식 데이터 공유
1. 이벤트 기반 아키텍쳐
    - 서비스가 특정 작업을 수행하거나 상태가 변경될 때, 이벤트를 메시지 브로커에 전달
    - 다른 서비스들은 해당 이벤트를 구독하고 필요한 작업을 수행
2. 메시지큐
    - 신뢰할 수 있고 확장 가능한 방식으로 서비스 간 메시지를 교환할 수 있도록 지원
    - 서비스는 특정 주제(topic)나 큐(queue)에 메시지를 게시 가능
    - 다른 서비스는 자신의 속도에 맞게 해당 메시지를 소비가능
3. 최종 일관성
    - 비동기식 데이터 공유에서는 서비스들이 로컬 사본을 유지하고, 이벤트를 기반으로 데이터를 업데이트
    - 서비스 간에 데이터가 잠시 동안 불일치할 수 있지만, 시간이 지나면서 일관된 상태로 수렴
    - 서비스의 독립성을 보장하면서도 성능을 향상시키기 위해 동기식 통신을 줄여줌
    - 장점 : 느슨한 결합, 확장성, 성능향상
    - 단점 : 일시적 데이터 불일치, 복잡성 증가, 메시지 순서보장 어려움, 오류처리

### 하이브리드 접근방식
- 동기식, 비동기식 전부 사용
- 필수 데이터는 로컬에 저장 / 상세정보는 필요 시 동기식으로 호출
- 장점 : 로컬 데이터로 중복 호출 감소, DB 크기 절약
- 단점 : 동기식 응답시간, 일부데이터가 서비스간 중복 저장되어 데이터 일관성 부족 가능
- 고려사항
  - 데이터 일관성, 캐싱 전략, 비동기 업데이트

### 트레이드 오프 평가
1. 일관성 평가
    - 강한 일관성 : 동기식
    - 최종 일관성 : 비동기식
2. 성능
   - 지연 시간 : 동기식은 시간 길어짐, 비동기식은 빠르지만 오래된 데이터 제공 가능
   - 처리량 : 동기식은 처리량 제한, 비동기식은 처리량 높음
   - 자원 활용 : 동기식은 데이터 무결성을 위해 리소스 높음, 최종 일관성은 로컬 데이터를 사용해 효율적이지만, 추가저장공간 필요
3. 확장성
    - 수평확장성 : 동기식은 어려움, 비동기식은 유리
    - 데이터 양 : 동기식은 점점 일관성 유지 어려워짐, 비동기식은 효율적으로 처리 가능하지만 동기화 관리 필요
    - 서비스 독립성 : 비동기식이 유리
